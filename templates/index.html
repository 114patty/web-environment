<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
    <link rel="stylesheet" href="/static/css/theme.css"> 
    <script src="/static/js/theme.js" defer></script>

                             
    <meta charset="UTF-8">              
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMU 姿態數據監測</title>                                                                                                                                       
                                                                                                                                                                                                
    <style>                                                                                                                                                                                                                                                                     
        :root {                   
            --theme-bg: #f6f3e8; /* 主背景 */
            --theme-text: #333333; /* 文字 */
            --theme-tab-bg: #f6f3e8; /* 分頁背景 */
            --theme-tab-active-bg: #ffffff; /* 選中分頁背景 */
            --theme-container-bg: #ffffff;
            --theme-surface: #ffffff;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ;   /* 主容器背景（如框框） */
            --theme-section: #fbf9f3;  /* 區塊或表格內部的底色 */
            --theme-table-header-bg: #fbf9f3;
            --theme-border: #b0a99f;
        }
        body { font-family: Arial, sans-serif;transition: margin-left 0.3s ease; margin: 20px; background-color: var(--theme-bg); color: var(--theme-text); }
        .container { max-width: 900px; margin: auto; background: var(--theme-surface);padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--theme-heading); }

        /* 外框容器 */
        .dashboard-body {
            background-color: var(--theme-section);
            border-radius: 12px;
            padding: 24px;
            margin-top: -16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            border: none; 
        }
        /* 分頁容器 */
        .data-section {
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            border: none; 
        }

        table {
            width: auto;           /* 根據內容自動調整表格寬度 */
            max-width: 100%;       /* 避免超出容器寬度 */
            table-layout: auto;    
            margin-bottom: 20px; /* Add some space below table */
        }
        /* 側邊欄樣式 */
        #sidebar {
            position: fixed;
            top: 0;
            left: -200px; /* 預設隱藏 */
            width: 200px;
            height: 100%;
            background-color: #f4f4f4;
            border-right: 1px solid #ccc;
            padding-top: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: left 0.3s ease;
            z-index: 2000;
        }

        #sidebar h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        #sidebar a {
            display: block;
            padding: 12px;
            text-decoration: none;
            color: #333;
            border-bottom: 1px solid #ddd;
            transition: background-color 0.3s;
        }

        #sidebar a:hover {
            background-color: #ddd;
        }
         /* 主內容 */
        #main-content {
            transition: margin-left 0.3s ease;
            padding: 20px;
        }

        /* 側邊欄按鈕 */
        #sidebar-btn {
            position: fixed;
            top: 40px;
            left: 0;
            background-color: #333;
            color: white;
            padding: 10px;
            cursor: pointer;
            border-radius: 0 5px 5px 0;
            transition: left 0.3s ease;
            z-index: 2100;
        }

        /* hover 時展開側邊欄並推動主內容 */
        #sidebar-btn:hover + #sidebar,
        #sidebar:hover {
            left: 0;
        }

        #sidebar-btn:hover ~ #main-content,
        #sidebar:hover ~ #main-content {
            margin-left: 200px;
        }

        /* 表格樣式 */
        table th,
        table td {
        border: 1px solid var(--theme-table-border);
        padding: 8px;
        text-align: center;
        vertical-align: middle;
        white-space: nowrap;
        }
        table th {
            background-color: var(--theme-table-header-bg);
            color: var(--theme-text);
        }

        /* 電量 */
        .battery-display {
        position: absolute;
        top: 0;
        right: 50px; /* 可依需求微調距離 */
        font-size: 14px;
        color: #007b00;
        }
        .battery-watch {
        position: absolute;
        top: 5;
        right: 50px; /* 可依需求微調距離 */
        font-size: 14px;
        color: #007b00;
        }
        .header-title {
        position: relative;  /* 讓 .battery-display 的 absolute 參考這個容器 */
        text-align: center;
        }
        /* 今日消耗資訊 */
        .summary-text {
        font-size: 18px;
        margin-bottom: 20px;
        color: #d39052;
        }
        /* 姿態圖表外框 */
        .chart-container {
            position: relative; 
            width: 100%;
            max-width: 820px; 
            margin: 20px auto;
            background: #fdfdfd;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* 分頁容器 */
        #macTabs {
        display: flex;
        margin-bottom: 16px;
        padding-left: 8px;
        overflow-x: auto;
        }
        /* 分頁按鈕（未選取狀態） */
        .mac-tab {
        padding: 8px 16px;
        background: #e4e9ec;
        color: var(--theme-text);
        border: none;
        border-radius: 12px 12px 0 0;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        margin-right: 6px;
        height: 45px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .mac-tab:hover {
        background:#d3d7dc;   /* 滑鼠移上去變淺灰 */
        }
        /* 分頁按鈕（選取狀態） */
        .mac-tab.active {
        background: var(--theme-section);
        border-color: #aaaaaa;
        border-bottom: 2px solid #ffffff;
        height: 45px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        /* 右鍵選單 */
        .custom-context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 9999;
            padding: 8px 12px;
            cursor: pointer;
            display: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .custom-context-menu:hover {
            background-color: #f5f5f5;
        }
        /* loading 樣式 */
        body.loading {
            cursor: wait;
        }
        .chart-container.loading::after {
            content: '載入中...';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #888;
            background: rgba(255,255,255,0.8);
            padding: 10px 20px;
            border-radius: 5px;
        }
 
    </style>
</head>
<body>

    <!-- 側邊欄 -->
    {% include 'partials/sidebar.html' %}



    <div class="container">
        <div class="header-title">
            <h1>IMU 姿態數據監測</h1>
        </div>
        <div style="position: relative;">
            <span class="battery-display" id="safe_battery">平安符電量：--%</span>
            <p>每 1 秒自動更新數據      最後更新時間：<span id="lastUpdateTime">--</span></p>
            <span class="battery-watch" id="band_battery">手環電量：--%</span>

        </div>

        <div style="margin-bottom: 20px;">
            <label for="macSelector">選擇裝置：</label>
            <select id="macSelector">
                <option disabled selected>載入中...</option>
            </select>
            <button onclick="addSelectedMacTab()">➕ 加入裝置</button>
    </div>

    <div id="macTabs" class="mac-tabs-wrapper"></div>
        <!-- 分頁 + 數據區塊 -->
    <div class="dashboard-body">
        <div class="data-section">

        <h2>最新數據</h2>
        <div style="overflow-x: auto;">
            <table class="table table-bordered" id="dataDisplay">
                <thead>
                    <tr>
                      <th rowspan="2">時間</th>
                      <!-- <th rowspan="2">設備 MAC</th> -->
                      <th rowspan="2">姿態狀態</th>
                      <th rowspan="2">Roll (翻滾)</th>
                      <th rowspan="2">Pitch (俯仰)</th>
                      <th rowspan="2">Yaw (偏擺)</th>
                      <th colspan="3">加速度 (g)</th>
                      <th rowspan="2">總加速度 (g)</th>
                      <th colspan="3">磁力</th>
                      <th rowspan="2">總磁力</th>
                    </tr>
                    <tr>
                      <th>X</th>
                      <th>Y</th>
                      <th>Z</th>
                      <th>X</th>
                      <th>Y</th>
                      <th>Z</th>
                    </tr>
                  </thead>
            <tbody>
            </tbody>
        </table>
        </div>

        <div style="overflow-x: auto;">
        <h2 style="margin-top: 30px;">生理數據</h2>
        <p class="summary-text">
            今日消耗 熱量：<span id="Calories">--</span> 大卡 /
            步數：<span id="Step">--</span> 步 /
            距離：<span id="Mileage">--</span> 公里
        </p>
        <table id="environmentDataDisplay">
            <thead>
                <tr>
                    <th>時間戳</th>
                    <th>心率 (次/分鐘)</th>
                    <th>血壓</th>
                    <th>血氧</th>
                    <th>體溫 (°C)</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        </div>

        <h2 style="margin-top: 30px;">動態分析</h2>
        <div>
            <label for="timeWindowSelector" style="margin-left: 20px;">顯示時間區間：</label>
            <select id="timeWindowSelector">
                <option value="60">近 1 分鐘</option>
                <option value="300">近 5 分鐘</option>
                <option value="600">近 10 分鐘</option>
                <option value="1800">近 30 分鐘</option>
                <option value="3600">近 1 小時</option>
                <option value="18000">近 5 小時</option>
                <option value="36000">近 10 小時</option>
                <option value="86400">近 24 小時</option>
            </select>
          </div>
        <div class="chart-container">
        <div style="width: 100%; height: 400px;">
            <canvas id="postureTimelineChart"></canvas>
        </div>
    </div>

    <script>
        // Chart 實例變數
        let postureTimelineChart;

        const postureHistory = {};     // ✅ 每個 MAC 一份資料
        const lastTimestamps = {};     // ✅ 每個 MAC 一份時間點

        // 定義每個姿態狀態的顏色 (1-8) 和文字描述
        // 注意: 這裡的姿態文字與您的第一個問題中提供的有些不同，我沿用了您現在代碼中的定義。
        // 如果需要，請根據實際的姿態狀態定義進行調整。
        const postureColors = {
            '1': '#4CAF50', // 綠色 (坐姿 - 根據 postureText 調整)
            '2': '#2196F3', // 藍色 (站立 - 根據 postureText 調整)
            '3': '#FFC107', // 琥珀色 (躺臥)
            '4': '#FF9800', // 橘色 (右躺)
            '5': '#F44336', // 紅色 (跌倒)
            '6': '#9C27B0', // 紫色 (趴臥)
            '7': '#795548', // 棕色 (左躺)
            '8': '#607D8B', // 藍灰色 (走路)
        };

        const postureText = {
            '1': '坐姿',
            '2': '站立',
            '3': '躺臥',
            '4': '右躺',
            '5': '跌倒',
            '6': '趴臥',
            '7': '左躺',
            '8': '走路',
        };

        let activeMacTabs = [];      // 已建立的分頁裝置 MAC
        let currentActiveMac = null; // 目前顯示的裝置


        // ---- 狀態儲存工具 ----
        function saveTabsState() {
        localStorage.setItem('activeMacTabs', JSON.stringify(activeMacTabs));
        localStorage.setItem('currentActiveMac', currentActiveMac ?? '');
        }

        function loadTabsState() {
        try {
            const tabs = JSON.parse(localStorage.getItem('activeMacTabs') || '[]');
            const current = localStorage.getItem('currentActiveMac') || null;
            if (Array.isArray(tabs)) activeMacTabs = tabs;
            currentActiveMac = current || (activeMacTabs[0] ?? null);
        } catch {}
        }


        // 偵測所有 Mac
        function MacSelector() {
            fetch('/api/mac_list') // 後端回傳所有 MAC 的 API
                .then(response => response.json())
                .then(macList => {
                    const selector = document.getElementById('macSelector');
                    selector.innerHTML = ''; // 清空原有選項

                    if (!Array.isArray(macList) || macList.length === 0) {
                        selector.innerHTML = '<option disabled>無裝置可選擇</option>';
                        return;
                    }

                    // 動態新增選項
                    macList.forEach((mac, index) => {
                        const option = document.createElement('option');
                        option.value = mac;
                        option.textContent = `裝置 ${index + 1} - ${mac}`;
                        selector.appendChild(option);
                    });

                    // 如果本來就有選取，沿用；否則選第一個但不要清狀態
                    if (currentActiveMac && macList.includes(currentActiveMac)) {
                        selector.value = currentActiveMac;
                    } else {
                        currentActiveMac = macList[0];
                        saveTabsState();
                    }
                    })
                    
                .catch(error => {
                    console.error('取得 MAC 清單失敗:', error);
                    const selector = document.getElementById('macSelector');
                    selector.innerHTML = '<option disabled>載入失敗</option>';
                });
        }

        //  載入所有 MAC 裝置進選單
        async function MacListDropdown() {
            try {
                const res = await fetch('/api/mac_list');
                const macList = await res.json();

                const dropdown = document.getElementById('macSelector');
                dropdown.innerHTML = ''; // 清空

                macList.forEach(mac => {
                    const option = document.createElement('option');
                    option.value = mac;
                    option.textContent = mac;
                    dropdown.appendChild(option);
                });
            } catch (err) {
                console.error('無法載入 MAC 清單:', err);
            }
        }
        
        // Tab 樣式切換
        function updateTabStyle() {
            document.querySelectorAll('#macTabs .mac-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.mac === currentActiveMac);
            });
        }

        // 新增 Mac 裝置分頁
        function addSelectedMacTab() {
            const dropdown = document.getElementById('macSelector');
            const selectedMac = dropdown.value;

            if (!(selectedMac in postureHistory)) {
                postureHistory[selectedMac] = [];    // 初始化姿態歷史
                lastTimestamps[selectedMac] = null;    // 初始化時間
            }


            if (activeMacTabs.includes(selectedMac)) {
                alert('這個裝置已加入！');
                return;
            }

            activeMacTabs.push(selectedMac);
            currentActiveMac = selectedMac;
            saveTabsState(); // <<<<<<<<<< 新增：存檔

            const tab = document.createElement('button');
            tab.textContent = `裝置 - ${selectedMac}`;
            tab.className = 'mac-tab';
            tab.dataset.mac = selectedMac;

            // 左鍵切換
            tab.onclick = () => {
                currentActiveMac = selectedMac;
                // 取得對應裝置的歷史與時間（如果不存在就初始化）
                postureHistory[currentActiveMac] ||= [];
                lastTimestamps[currentActiveMac] ||= null;
                saveTabsState(); 
                updateData();
                updatePostureChart();
                updateTabStyle();
            };

            // 右鍵點擊：彈出刪除確認
            tab.oncontextmenu = (e) => {
                e.preventDefault();
                showContextMenu(e.pageX, e.pageY, selectedMac, tab);
            };

            document.getElementById('macTabs').appendChild(tab);

            // 第一次新增就自動顯示
            updateData();
            updatePostureChart();
            updateTabStyle();
            checkMacTabsEmpty();
        }
        function checkMacTabsEmpty() {
            const tabContainer = document.getElementById('macTabs');
            const tabs = tabContainer.querySelectorAll('.mac-tab');
            if (tabs.length === 0) {
                tabContainer.style.display = 'none';
            } else {
                tabContainer.style.display = 'flex';
            }
        }
        // 右鍵點擊刪除裝置
        function showContextMenu(x, y, mac, tabElement) {
            const menu = document.getElementById('contextMenu');
            menu.style.left = `${x}px`;
            menu.style.top = `${y}px`;
            menu.style.display = 'block';

            // 先清除舊事件
            const newMenu = menu.cloneNode(true);
            menu.parentNode.replaceChild(newMenu, menu);

            // 加入刪除邏輯
            newMenu.onclick = () => {
                activeMacTabs = activeMacTabs.filter(m => m !== mac);

                if (currentActiveMac === mac) {
                    currentActiveMac = activeMacTabs[0] || null;
                }
                saveTabsState();

                tabElement.remove();
                updateData();
                updatePostureChart();
                updateTabStyle();
                checkMacTabsEmpty(); // 檢查是否要隱藏容器
                newMenu.style.display = 'none';
            };
        }


        // 初始化圖表
        function PostureTimelineChart() {
            const ctx = document.getElementById('postureTimelineChart').getContext('2d');
            postureTimelineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    datasets: [{
                        label: "姿態",
                        data: [],
                        backgroundColor: [],
                        borderSkipped: false
                    }]
                },
                    options: {
                        indexAxis: 'y', // 使條形圖水平顯示
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'second', // 預設單位，實際顯示會由 updatePostureChart 決定
                                    tooltipFormat: 'yyyy-MM/dd HH:mm:ss',
                                    displayFormats: {
                                        second: 'HH:mm:ss',
                                        minute: 'HH:mm',
                                        hour: 'HH:mm'
                                    }
                                },
                            title: { display: true, text: '時間' },
                            grid: {color: '#cccccc'}
                        },
                        y:  { 
                            type: 'category',
                            labels: ["坐姿", "站立", "躺臥", "右躺", "左躺", "趴臥", "走路", "跌倒"],
                            offset: true, 
                            grid: {
                            color: '#cccccc',
                            drawTicks: false,       // ✅ 不畫多餘刻度
                            },
                            ticks: {
                                align: 'center',   // ✅ 文字與 bar 對齊在中間
                                crossAlign: 'center'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                title: ctx => {
                                    const data = ctx[0].raw; 
                                    const start = luxon.DateTime.fromMillis(data.x[0]).toFormat('yyyy/MM/dd HH:mm:ss');
                                    const end = luxon.DateTime.fromMillis(data.x[1]).toFormat('yyyy/MM/dd HH:mm:ss');
                                    return `${start} - ${end}`;
                                },
                                label: function (context) {
                                    const data = context.raw;
                                    if (data && typeof data.duration === 'number') {
                                        let totalSeconds = Math.round(data.duration);

                                        const hours = Math.floor(totalSeconds / 3600);
                                        totalSeconds %= 3600;
                                        const minutes = Math.floor(totalSeconds / 60);
                                        const seconds = totalSeconds % 60;

                                        let result = '動作時間：';
                                        if (hours > 0) result += `${hours} 小時 `;
                                        if (minutes > 0) result += `${minutes} 分 `;
                                        if (seconds > 0 || (hours === 0 && minutes === 0)) result += `${seconds} 秒`;

                                        return result.trim();
                                    }

                                    return '動作時間：--';
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            intersect: false,  // ✅ 不一定要點到才能觸發
                            axis: 'x',
                        },
                        hover: {
                            mode: 'nearest',
                            intersect: false,  // ✅ 可以 hover 附近就觸發
                        },
                        legend: {
                            display: true, 
                            position: 'bottom',
                            labels: {
                                generateLabels: chart => {
                                        return Object.keys(postureText).map(stateKey => ({
                                            text: postureText[stateKey] ,
                                            fillStyle: postureColors[stateKey] ,
                                            strokeStyle: postureColors[stateKey] ,
                                            pointStyle: 'rect'
                                        }));
                                }
                            }
                        }
                    },
                    animation: false
                }
            });
        }
        
        let latestDataBuffer = [];
        

        function Mac_device() {
            return currentActiveMac;
        }

        
        //數據處理
        function updateData() {
            fetch('/api/latest_data') // 從 Flask 後端獲取數據
                .then(response => response.json())
                .then(data => {
                    const filteredData = data.filter(item => item.safe_Mac === Mac_device());

                    const dataTable = document.querySelector('#dataDisplay tbody');
                    dataTable.innerHTML = '';  

                    const physiologicalTable = document.querySelector('#environmentDataDisplay tbody');
                    physiologicalTable.innerHTML = '';

                    document.getElementById('lastUpdateTime').textContent = luxon.DateTime.now().toFormat('HH:mm:ss');

                    if (filteredData.length > 0) {
                        const latest = filteredData[filteredData.length - 1]; // 取得最新一筆資料

                        // 更新電量、熱量、步數、里程
                        document.getElementById('safe_battery').textContent = `平安符電量：${latest.safe_battery ?? '--'}%`;
                        document.getElementById('band_battery').textContent = `手環電量：${latest.band_battery ?? '--'}%`;
                        document.getElementById('Calories').textContent = latest.Calories ?? '--';
                        document.getElementById('Step').textContent = latest.Step ?? '--';
                        document.getElementById('Mileage').textContent = latest.Mileage ?? '--'; 

                        // ✅ 只取前 10 筆
                        const maxRows = 10;
                        const latestData = filteredData.slice(0 ,maxRows);

                    latestData.forEach(item => {

                        // 在表格中顯示最新的 IMU 數據
                        // 表格 1: 最新數據
                        const row = dataTable.insertRow();
                        row.insertCell().textContent = item.timestamp;
                        // row.insertCell().textContent = item.safe_Mac ?? '';
                        row.insertCell().textContent = postureText[String(item.Posture_state)] || postureText['unknown'];
                        row.insertCell().textContent = (typeof item.roll16 === 'number' ? (item.roll16*100).toFixed(1) + '°' : '');
                        row.insertCell().textContent = (typeof item.pitch16 === 'number' ? (item.pitch16*100).toFixed(1) + '°'  : '');
                        row.insertCell().textContent = (typeof item.yaw16 === 'number' ? (item.yaw16*100).toFixed(1) + '°' : '');
                        row.insertCell().textContent = (typeof item.ACC_X === 'number' ? item.ACC_X.toFixed(4) + ' g' : '');
                        row.insertCell().textContent = (typeof item.ACC_Y === 'number' ? item.ACC_Y.toFixed(4) + ' g' : '');
                        row.insertCell().textContent = (typeof item.ACC_Z === 'number' ? item.ACC_Z.toFixed(4) + ' g' : '');
                        row.insertCell().textContent = (typeof item.ACC_total === 'number' ? item.ACC_total.toFixed(4) + ' g' : '');
                        row.insertCell().textContent = (typeof item.MAG_X === 'number' ? Math.round(item.MAG_X) + '' : '');
                        row.insertCell().textContent = (typeof item.MAG_Y === 'number' ? Math.round(item.MAG_Y) + '' : '');
                        row.insertCell().textContent = (typeof item.MAG_Z === 'number' ? Math.round(item.MAG_Z) + '' : '');
                        row.insertCell().textContent = (typeof item.MAG_total === 'number' ? Math.round(item.MAG_total) + '' : '');

                        // 表格 2: 生理數據
                        const environmentRow = physiologicalTable.insertRow(); 
                        environmentRow.insertCell().textContent = item.timestamp;
                        environmentRow.insertCell().textContent = (typeof item.HR === 'number' ? Math.round(item.HR) + 'bpm': '');
                        environmentRow.insertCell().textContent = (typeof item.Bloodpressure_SBP === 'number' && typeof item.Bloodpressure_DBP === 'number') ? `${Math.round(item.Bloodpressure_SBP)} / ${Math.round(item.Bloodpressure_DBP)}` : '';
                        environmentRow.insertCell().textContent = (typeof item.Blood_oxygen === 'number' ? Math.round(item.Blood_oxygen) + '%': '');
                       
                        //溫度數據
                        let temperatureValue = item.Temperature;
                        if (typeof temperatureValue === 'string') {
                            const parsed = parseFloat(temperatureValue);
                            temperatureValue = Number.isFinite(parsed) ? parsed : null;
                        }
                        environmentRow.insertCell().textContent = (typeof temperatureValue === 'number' && !isNaN(temperatureValue)) ? `${temperatureValue.toFixed(1)}°C` : '';

                    });
                }

            })
                .catch(error => {
                    console.error('獲取數據失敗:', error);
                });
        }

        // 姿態時間單位換算
        function normalizeTimestamp(ts) {
            if (!ts) return null;

            // 如果是字串，先判斷是不是日期格式
            if (typeof ts === 'string') {
                const parsed = Date.parse(ts);
                if (!isNaN(parsed)) {
                    console.log("⏱️ normalizeTimestamp: 字串日期 →", ts, "→", parsed);
                    return parsed; // 已經是毫秒
                }
                ts = Number(ts);
            } else {
                ts = Number(ts);
            }

            if (!Number.isFinite(ts)) return null;

            // 🔍 判斷單位：小於 1e12 的是秒，大於等於的就是毫秒
            if (ts < 1e12) {
                // console.log("⏱️ normalizeTimestamp: 秒轉毫秒 →", ts, "→", ts * 1000);
                return ts * 1000;
            } else {
                // console.log("⏱️ normalizeTimestamp: 已是毫秒 →", ts);
                return ts;
            }
        }

        // 全域快取：每個 MAC 一份
        const postureCache = {};    // 記憶體內快取
        const fetchedMacs = new Set();

        // 儲存快取到 localStorage
        function saveCacheToLocal() {
            localStorage.setItem("postureCache", JSON.stringify(postureCache));
        }

        // 從 localStorage 載入快取
        function loadCacheFromLocal() {
            try {
                const cache = JSON.parse(localStorage.getItem("postureCache") || "{}");
                for (const mac in cache) {
                    postureCache[mac] = cache[mac];
                }
            } catch (e) {
                console.warn("⚠ 無法載入快取:", e);
            }
        }

        async function fetchPostureData(mac) {
            if (!mac) return { oneHour: [], fullDay: [] };

            // 如果記憶體或 localStorage 已有 → 直接用
            if (postureCache[mac]) {
                console.log(`⚡ 使用快取 (${mac})`, postureCache[mac]);
                return postureCache[mac];
            }

            // 第一次 → 先抓 1 小時
            console.log(`📡 抓 ${mac} 最近 1 小時資料`);
            const url = `/api/all_history_posechart?hours=1&mac=${encodeURIComponent(mac)}`;
            const res = await fetch(url);
            const oneHourData = await res.json();

            // ✅ log 一下回傳內容
            console.log("📡 [API回傳] 1小時：", oneHourData);

            postureCache[mac] = {
                oneHour: Array.isArray(oneHourData) ? oneHourData : [],
                fullDay: []
            };
            saveCacheToLocal();
            console.log(`✅ [API] ${mac} 1 小時資料載入完成，筆數：`, postureCache[mac].oneHour.length);

            // 背景再抓 24 小時（只做一次）
            if (!fetchedMacs.has(mac)) {
                fetchedMacs.add(mac);
                setTimeout(async () => {
                    try {
                        console.log(`⏳ 背景抓取 ${mac} 的完整 24 小時資料`);
                        const fullUrl = `/api/all_history_posechart?hours=24&mac=${encodeURIComponent(mac)}`;
                        const resFull = await fetch(fullUrl);
                        const fullData = await resFull.json();

                        // ✅ log 一下回傳內容
                        console.log("📡 [API回傳] 24小時：", fullData);

                        // 🛠️ 確保物件存在再設定
                        if (!postureCache[mac]) {
                            postureCache[mac] = { oneHour: [], fullDay: [] };
                        }

                        postureCache[mac].fullDay = Array.isArray(fullData) ? fullData : [];
                        saveCacheToLocal();
                        console.log(`✅ [API] ${mac} 24 小時資料快取完成，筆數：`, postureCache[mac].fullDay.length);
                        
                        // 🟢 抓完 24 小時資料後，通知刷新圖表
                        if (currentActiveMac === mac) {
                            updatePostureChart();
                        }
                    } catch (err) {
                        console.error("❌ 背景抓取 24 小時資料失敗:", err);
                    }
                }, 2000); // 延遲 2 秒後再抓
            }

            return postureCache[mac];
        }


        // 姿態圖表
        async function updatePostureChart() {
            try {
                const mac = Mac_device();
                if (!mac) return;

                const timeWindowSeconds = Number(document.getElementById('timeWindowSelector').value); 
                const currentTime = luxon.DateTime.now();
                const minMs = currentTime.minus({ seconds: timeWindowSeconds }).toMillis();

                // 抓資料（不會重複打 API）
                const dataSet = await fetchPostureData(mac);

                // 選用 oneHour 或 fullDay
                let allData = [];
                if (timeWindowSeconds <= 3600) {
                    allData = Array.isArray(dataSet.oneHour) ? dataSet.oneHour : [];
                } else {
                    allData = (Array.isArray(dataSet.fullDay) && dataSet.fullDay.length > 0) 
                        ? dataSet.fullDay 
                        : (Array.isArray(dataSet.oneHour) ? dataSet.oneHour : []);
                }

                // 🟢 Debug：顯示目前資料來源 & 筆數
                console.log("📊 updatePostureChart 用資料來源：", 
                    timeWindowSeconds <= 3600 ? "oneHour" : 
                    (dataSet.fullDay.length > 0 ? "fullDay" : "oneHour"),
                    "筆數：", allData.length
                );

                // 🟢 Debug：印前 5 筆 startTime / endTime
                allData.slice(0, 5).forEach((s, i) => {
                    console.log(`🔍 allData[${i}]`, {
                        rawStart: s.startTime,
                        rawEnd: s.endTime,
                        normStart: normalizeTimestamp(s.startTime),
                        normEnd: normalizeTimestamp(s.endTime ?? s.startTime)
                    });
                });

                // 🟢 Debug：印時間範圍
                console.log("⏱ minMs:", minMs, 
                    luxon.DateTime.fromMillis(minMs).toISO(),
                    " ~ max:", currentTime.toMillis(), 
                    luxon.DateTime.fromMillis(currentTime.toMillis()).toISO()
                );

                // === 過濾時間範圍 ===
                let postureChanges = allData.filter(s => {
                    const startMs = normalizeTimestamp(s.startTime);
                    const endMs = normalizeTimestamp(s.endTime ?? s.startTime);
                    return endMs >= minMs && startMs <= currentTime.toMillis();
                }).map(s => ({
                    ...s,
                    startTime: normalizeTimestamp(s.startTime),
                    endTime: normalizeTimestamp(s.endTime ?? s.startTime)
                }));

                // fallback
                if (postureChanges.length === 0) {
                    console.warn("⚠️ postureChanges 過濾後為空，直接用 allData");
                    postureChanges = allData.map(s => ({
                        ...s,
                        startTime: normalizeTimestamp(s.startTime),
                        endTime: normalizeTimestamp(s.endTime ?? s.startTime)
                    }));
                }

                // === Chart.js dataset ===
                const dataset = {
                    label: "姿態",
                    backgroundColor: [],
                    data: [],
                    borderSkipped: false,
                    barPercentage: 0.6,
                    categoryPercentage: 0.8,
                    barThickness: 30,
                    parsing: { xAxisKey: "x", yAxisKey: "y" },
                };

                postureChanges.forEach(segment => {
                    const state = String(segment.state);
                    const startMs = segment.startTime;
                    const endMs   = segment.endTime;

                    dataset.data.push({ 
                        x: [startMs, endMs], 
                        y: postureText[state] || "未知",
                        duration: (endMs - startMs) / 1000
                    });
                    dataset.backgroundColor.push(postureColors[state] || 'gray');
                });

                const chartDataset = postureTimelineChart.data.datasets[0];
                chartDataset.data = dataset.data;
                chartDataset.backgroundColor = dataset.backgroundColor;

                let maxTicks = 8;
                if (timeWindowSeconds <= 600) maxTicks = 6;      // 10 分鐘內
                else if (timeWindowSeconds <= 3600) maxTicks = 8; // 1 小時
                else if (timeWindowSeconds >= 86400) maxTicks = 12; // 24 小時
                
                // === 設定時間軸 ===
                let unit, stepSizeValue, timeFormat;
                if (timeWindowSeconds <= 60) {
                    unit = 'second'; stepSizeValue = 10; timeFormat = 'HH:mm:ss'; maxTicks = 6;
                } else if (timeWindowSeconds <= 600) {
                    unit = 'minute'; stepSizeValue = 2; timeFormat = 'HH:mm'; maxTicks = 8;
                } else if (timeWindowSeconds <= 3600) {
                    unit = 'minute'; stepSizeValue = 5; timeFormat = 'HH:mm'; maxTicks = 10;
                } else {
                    unit = 'hour'; stepSizeValue = 2; timeFormat = 'HH:mm'; maxTicks = 12;
                }

                let minBound, maxBound;
                if (timeWindowSeconds >= 86400) {
                    // 取資料的最小 / 最大時間
                    const times = allData.flatMap(s => [
                        normalizeTimestamp(s.startTime),
                        normalizeTimestamp(s.endTime ?? s.startTime)
                    ]).filter(Boolean);      

                    if (times.length > 0) {
                    minBound = Math.min(...times);
                    maxBound = Math.max(...times);

                    // 如果範圍太小 (< 24h * 0.9)，fallback
                    const duration = maxBound - minBound;
                    if (duration < timeWindowSeconds * 0.9 * 1000) {
                        console.warn("⚠️ 24h mode 資料不足，改用 minMs ~ currentTime 範圍");
                        minBound = minMs;
                        maxBound = currentTime.toMillis();
                    }
                } else {
                    // 如果完全沒有資料，也用 minMs
                    console.warn("⚠️ 24h mode 無資料，改用 minMs ~ currentTime 範圍");
                    minBound = minMs;
                    maxBound = currentTime.toMillis();
                }
            } else {
                // < 24h 時間區間，直接用理論範圍
                minBound = minMs;
                maxBound = currentTime.toMillis();
            }

                postureTimelineChart.options.scales.x = {
                    type: 'time',
                    time: { unit, stepSize: stepSizeValue, displayFormats: { [unit]: timeFormat }, tooltipFormat: timeFormat },
                    min: minBound,
                    max: maxBound,
                    grid: { display: true, color: '#cccccc' },
                    ticks: {
                        source: 'auto',        // ✅ 讓 Chart.js 自動挑選刻度
                        maxTicksLimit: maxTicks       // ✅ 最多顯示 8 個 (可依需要調整成 6、10)
                    }
                };

                postureTimelineChart.update('none'); // 無動畫更新

            } catch (error) {
                console.error("更新圖表失敗:", error);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            loadCacheFromLocal();   // ✅ 頁面刷新後讀 localStorage
            PostureTimelineChart(); // 初始化圖表結構
            loadTabsState(); // <<<<<< 先讀本機狀態

            const theme = {
                '--theme-bg': '#f6f3e8',  
                '--theme-text': '#333333',
                '--theme-tab-bg': '#f6f3e8',
                '--theme-tab-active-bg': '#ffffff',
                '--theme-container-bg': '#fbf9f3',
                '--theme-table-header-bg': '#f0dda4'
            };
            setTheme(theme); // ✅ 套用變數

            // 依照儲存的 tabs 重建 UI
            const tabsWrap = document.getElementById('macTabs');
            activeMacTabs.forEach(mac => {
                const tab = document.createElement('button');
                tab.textContent = `裝置 - ${mac}`;
                tab.className = 'mac-tab';
                tab.dataset.mac = mac;
                tab.onclick = () => {
                    currentActiveMac = mac;
                    saveTabsState(); // <<<<<< 存檔
                    postureHistory[mac] ||= [];
                    lastTimestamps[mac] = lastTimestamps[mac] ?? null;
                    updateData();
                    updatePostureChart();
                    updateTabStyle();
                };
                tab.oncontextmenu = (e) => {
                    e.preventDefault();
                    showContextMenu(e.pageX, e.pageY, mac, tab);
                };
                tabsWrap.appendChild(tab);
            });
            updateTabStyle(); // 更新分頁樣式（確保 active 狀態正確）

            MacSelector(); // 只負責更新下拉選單           
            checkMacTabsEmpty();
            MacListDropdown(); // ✅ 載入下拉選單的裝置清單

            // 如果有已選裝置，讓下拉選單顯示它
            const dropdown = document.getElementById('macSelector');
            const setDropdownToActive = () => {
                if (currentActiveMac && [...dropdown.options].some(o => o.value === currentActiveMac)) {
                    dropdown.value = currentActiveMac;
                }
            };
            setTimeout(setDropdownToActive, 300);

            setInterval(updateData, 1000); // 設定每 1 秒更新數據的間隔

            let postureChartTimer = null;

            function scheduleChartUpdate() {
                const now = Date.now();
                if (now < chartUpdatePausedUntil) return;  // 暫停中，不更新

                clearTimeout(postureChartTimer);
                postureChartTimer = setTimeout(() => {
                    updatePostureChart();
                }, 300); // 延遲 300ms 更新，避免切換太快造成衝突
            }

            // 當時間區間選單改變時更新圖表
            document.getElementById('timeWindowSelector').addEventListener('change', async (e) => {
                const selectedTime = e.target.value;
                localStorage.setItem('selectedTimeWindow', selectedTime);  // ← 儲存到 localStorage
                // updatePostureChart(); // 原本的動作
                const chartContainer = document.querySelector('.chart-container');
                chartContainer.classList.add('loading');

                try {
                    await updatePostureChart();
                } catch (error) {
                    console.error("更新圖表失敗:", error);
                } finally {
                    chartContainer.classList.remove('loading');
                }
            });

            const savedTime = localStorage.getItem('selectedTimeWindow');
            if (savedTime) {
                const timeSelector = document.getElementById('timeWindowSelector');
                if ([...timeSelector.options].some(opt => opt.value === savedTime)) {
                    timeSelector.value = savedTime;
                }
            }

            // ✅ 當使用者選擇不同 MAC 裝置時，清空歷史並更新資料
            document.getElementById('macSelector').addEventListener('change', () => {
                currentActiveMac = document.getElementById('macSelector').value;
                saveTabsState(); // <<<<<< 存檔
                updateData();
                updatePostureChart();
                updateTabStyle();
            });

            // 點擊其他地方隱藏右鍵選單
            document.addEventListener('click', () => {
                document.getElementById('contextMenu').style.display = 'none';
            });

            // 圖表初始化：進來時先抓一次完整 24 小時
            updatePostureChart();

            let lastKnownTimestamp = 0;

            setInterval(async () => {
                try {
                    const res = await fetch('/api/last_timestamp');
                    const { last_ts } = await res.json();
                    if (last_ts && last_ts > lastKnownTimestamp) {
                        // console.log("⚡ 偵測到新資料，更新圖表");
                        lastKnownTimestamp = last_ts;
                        postureCache[currentActiveMac] = null;
                        updatePostureChart();  // 有新資料才更新
                    }
                } catch (err) {
                    console.error("檢查最新資料失敗:", err);
                }
            }, 3000); // 每 3 秒檢查一次


            // 每秒重繪一次圖表（用快取資料，不打 API）
        //    setInterval(() => {
        //         if (currentActiveMac && postureCache[currentActiveMac]) {
        //             const cache = postureCache[currentActiveMac];

        //             const timeWindowSeconds = Number(document.getElementById('timeWindowSelector').value);
        //             let history = [];

        //             if (timeWindowSeconds <= 3600) {
        //                 history = cache.oneHour || [];
        //             } else {
        //                 history = (cache.fullDay && cache.fullDay.length > 0) ? cache.fullDay : (cache.oneHour || []);
        //             }

        //             const dataset = postureTimelineChart.data.datasets[0];
        //             dataset.data = history.map(seg => ({
        //                 x: [normalizeTimestamp(seg.startTime), normalizeTimestamp(seg.endTime ?? seg.startTime)],
        //                 y: postureText[seg.state] || "未知",
        //                 duration: ((normalizeTimestamp(seg.endTime ?? seg.startTime) - normalizeTimestamp(seg.startTime)) / 1000)
        //             }));
        //             dataset.backgroundColor = history.map(seg => postureColors[seg.state] || 'gray');
        //             postureTimelineChart.update('none');
        //         }
        //     }, 1000);

        });

    </script>

    <div id="contextMenu" class="custom-context-menu">刪除裝置</div>

</body>
</html> 